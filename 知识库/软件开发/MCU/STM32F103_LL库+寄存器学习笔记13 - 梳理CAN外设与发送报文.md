# 导言
---
CAN总线因其高速稳定的数据传输与卓越抗干扰性能，在汽车、机器人及工业自动化中被广泛应用。它采用分布式网络结构，实现多节点间实时通信，确保各控制模块精准协同。在汽车领域，CAN总线连接发动机、制动、车身系统，保障车辆安全；在机器人和工业控制中，传感器与执行器间信息传递迅速，使其成为智能制造与自动化控制不可或缺的重要技术。

遗憾的是CubeMX不支持生成CAN总线的LL库代码。所以，梳理完HAL库的实现方式后，继续梳理寄存器方式的实现。
以下是本章节的效果，开发板每隔100ms往CAN总线发送一个报文。CANID是0x0123，数据帧，标准帧，长度0x08，内容是0x01,0x02,0x03,0x04,0x05,0x06,0x07,0x08。
![[LL12_CAN_Send.gif]]

项目地址：

# 一、CubeMX
---
## 1.1、Clock Configuration
![[Pasted image 20250317200635.png | 1100]]

## 1.2、Parameter Settings
![[Pasted image 20250317214148.png | 1100]]
采样点的设置是CAN稳定通讯的前提！
采样点的设置是CAN稳定通讯的前提！
采样点的设置是CAN稳定通讯的前提！
如上所示，配置的重点是4分频、Tq1 = 14Times、Tq2 = 3Times。此时采样点的计算如下：
采样点位置，采样点在同步段后的 Tq1 处，即 1 + 14 = 15 Tq，采样点比例 = 15 / 18 ≈ 83.3%。所以，**Prescaler = 4, Tq1 = 14, Tq2 = 3 这种配置可以精确得到 500 kbps，并且采样点位于约 83.3% 的位置，这是一个较为合理的采样位置，既能保证波特率精确，又能提供足够的采样稳定性**。参考我的另外一篇博文[《CAN总线技术 | 物理层03 - 采样点》](https://blog.csdn.net/wallace89/article/details/119811949)

![[Pasted image 20250317201002.png | 1100]]


# 二、代码（HAL库）
---
## 2.1、main.c
![[Pasted image 20250317194721.png | 1100]]
![[Pasted image 20250317194914.png | 1100]]
如上所示，通过HAL库来实现CAN发送的代码实在简单。

## 2.2、编译、下载代码
![[Pasted image 20250317194940.png | 1100]]
如上所示，编译通过。下载代码到开发板后，效果如下：
![[LL12_CAN_Send 1.gif]]

# 三、梳理CAN发送
---
## 3.1、发送邮箱
CAN发送比CAN接收要简单许多，所以先从简单的CAN发送开始梳理。
![[Pasted image 20250317203852.png]]
![[Pasted image 20250317203951.png | 800]]
如上所示，CAN一共有三个发送邮箱，所以为什么函数`Test_CAN_Send_Msg()`里需要用`HAL_CAN_GetTxMailboxesFreeLevel()`去判断有没有空的发送邮箱，才能将需要发送的CAN报文丢进去发送邮箱。CAN的发送邮箱相当于串口的发送数据寄存器USART_TDR。只是CAN的发送邮箱一共有3个，而串口的发送数据寄存器USART_TDR只有一个。显然，CAN的发送缓存比串口的发送缓存要大得多。
请记住，软件只能将需要发送的CAN消息放到发送邮箱，并不是将CAN消息发送到总线。

## 3.2、发送优先级
![[Pasted image 20250317205358.png]]
如上所示，从《STM32F1参考手册》的章节22.7.1-发送处理看到，CAN消息的发送优先级有两种设置，通过寄存器CAN_MCR的位TXFP置1，开启FIFO模式。值得注意的是，寄存器CAN_MCR的位TXFP默认是置0，即标识符决定发送优先级。另外，标识符越小，优先级越高。
![[Pasted image 20250317205941.png | 800]]

## 3.3、标识符是什么？
如下图所示，标识符就是CANID。
![[Pasted image 20250317205843.png]]

## 3.4、终止发送
![[Pasted image 20250317210640.png]]
总的来说，如果你只是想快速清除发送邮箱，不关注TXOK的状态，那么只需要将ABRQ置1即可。

## 3.5、禁止自动重传模式
![[Pasted image 20250317210809.png]]
**默认是禁止自动重传模式的**，禁止CAN自动重传功能的影响主要体现在以下几点：
1. **消息丢失风险增大**
当一帧CAN报文发送失败（例如由于总线干扰或仲裁错误）时，如果自动重传被禁用，硬件不会重新尝试发送这帧报文，导致该报文直接丢失。此时，如果没有额外的软件层重传机制，就可能影响通信的可靠性。
2. **降低传输延时**
在一些实时性要求高的应用中，自动重传可能会引入额外延时。禁用自动重传可以使得一旦检测到发送失败就立即放弃，从而避免因连续重传而延迟后续消息的发送。
3. **简化错误处理逻辑**
禁用自动重传后，发送操作完成后，邮箱状态总会变为空置（无论是成功发送或发送失败），这对某些系统来说可以简化对邮箱状态的监控和管理。不过，这也意味着应用层需要增加判断和处理发送失败的逻辑，以决定是否进行重发或者采取其他补救措施。
4. **总线负载和资源利用**
自动重传在错误发生时可能导致总线负载增加，尤其在总线故障或者干扰情况下频繁重传会占用大量资源。禁用自动重传可以防止这种情况，但同时需要确保上层有机制去检测和响应通信错误。**总之，禁用自动重传功能是一种在追求低延时和精细控制CAN通信时的取舍，但需要权衡消息可靠性和实时性，通常需要在应用层增加适当的错误检测和补救机制。**

![[Pasted image 20250317211940.png | 800]]






## 3.6、500K波特率，发送8个字节的CAN标准帧消息，需要多长时间？
理论上，我们可以计算标准CAN数据帧的位数，再乘以每位的传输时间。对于标准CAN数据帧（CAN 2.0A），各部分位数通常为：
- 起始位 (SOF)：1位
- 仲裁段：11位标识符 + 1位远程传输请求（RTR） = 12位
- 控制段：6位（包括IDE、保留位以及4位数据长度代码 DLC）
- 数据段：8字节 × 8 = 64位
- CRC段：15位CRC + 1位CRC分隔符 = 16位
- 确认段 (ACK)：2位
- 结束位 (EOF)：7位
总计：1 + 12 + 6 + 64 + 16 + 2 + 7 = 108位

在500k波特率下，每位传输时间为：1 / 500,000 = 2微秒。因此，理论上传输108位的CAN报文所需时间为：108 × 2μs = 216微秒。注意：这只是理论传输时间，实际情况还可能受到位填充、总线仲裁和间隔等因素影响，但理论上就是**216微秒**。




