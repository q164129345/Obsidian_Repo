# 导言
---
![[Pasted image 20250414200204.png | 600]]
如上所示，本章节的目的是在《[[STM32F103_HAL库+寄存器学习笔记17 - CAN中断接收 + 接收CAN总线所有报文]]》的基础上增加强大的数据结构ringbuffer。ringbuffer是嵌入式MCU开发必须掌握的数据结构。优点如下：
1. **缩短中断处理时间**
在中断服务程序（ISR）中，只需要尽快把接收到的数据存入ringbuffer，然后立即退出中断。这样可以保证中断处理时间尽可能短，降低对系统其他高优先级任务的影响。短时间的中断处理对实时性要求较高的系统尤为重要。
2. **解耦中断与数据处理**
将数据先存入ringbuffer，可以把数据处理工作从中断上下文中剥离出来，在主循环或者专门的任务中再进行数据解析和处理。这种方式降低了中断内执行复杂计算或处理逻辑时对整个系统实时响应的负面影响。
3. **缓冲突发数据**
在CAN总线上，当有数据突发或短时间内大量数据到达时，ringbuffer能够临时缓存这些数据，避免中断处理时间不足导致数据丢失。即使主循环在短时段内处理不过来，ringbuffer可以起到缓冲作用，从而增强系统的鲁棒性。
4. **保证数据顺序**
环形缓冲区本质上是先进先出的（FIFO）结构，能够保持接收到的数据顺序一致性。这对于需要按照接收顺序依次处理的数据帧来说非常重要。
5. **提高系统整体效率与可维护性**
将数据接收和数据处理分离后，系统各部分的功能更加模块化，便于后续维护与扩展。中断函数只负责数据的快速存储，而数据处理模块可以采用更灵活的调度机制进行处理和响应。
6. **防止中断嵌套和竞态条件**
使用ringbuffer还可以降低在中断中长时间占用处理资源带来的潜在问题，如中断嵌套或与其他共享资源的竞态问题。只需注意在操作ringbuffer时进行合适的同步（如临界区保护、原子操作等），以确保数据一致性。
总之，在CAN接收中断中采用ringbuffer设计能够提高系统的实时性、稳定性以及灵活性，既减少了中断处理时间，又能有效管理和处理突发数据，从而为整个系统构建一个高效可靠的数据处理链路。

# 一、移植开源ringbuffer - LwRB
---
## 1.1、简单介绍
官方：https://docs.majerle.eu/projects/lwrb/en/latest/index.html
![[Pasted image 20250414202458.png | 800]]
如上所示，LwRB的功能很齐全。一般，新手应该先从怎样放入消息与怎样取出消息先开始。

## 1.2、clone源码到本地
git仓库：https://github.com/MaJerle/lwrb/tree/develop
![[Pasted image 20250414202913.png | 1100]]
如上所示，复制git仓库地址。
![[Pasted image 20250414204148.png | 800]]
如上所示，使用git clone指令克隆git远程仓库。
![[Pasted image 20250414204350.png | 800]]
如上所示，克隆完毕。
![[Pasted image 20250414212528.png | 800]]
## 1.3、添加.c源码
![[Pasted image 20250414204610.png | 1000]]
如上所示，将`stm32f103_hal_library19_Can_Rec_With_RB\lwrb\lwrb\src\lwrb\`文件夹下的两个.c源代码文件添加到Keil项目。
![[Pasted image 20250414205027.png | 1000]]
## 1.4、设置include地址
![[Pasted image 20250414205714.png]]
![[Pasted image 20250414205733.png]]
如上所示，完成包含LwRB库的头文件地址。

## 1.5、main.h
![[Pasted image 20250414210029.png | 1000]]
如上所示，在工程的main.h里包含LwRB的头文件。

## 1.6、编译代码
![[Pasted image 20250414210126.png | 1000]]
如上所示，编译代码成功！移植成功！

## 二、代码（HAL库）
---
## 2.1、myCanDrive.c


