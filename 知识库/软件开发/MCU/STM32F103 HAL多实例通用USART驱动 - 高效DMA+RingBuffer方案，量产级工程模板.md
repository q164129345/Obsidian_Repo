# 导言
---
《[[STM32F103_LL库+寄存器学习笔记12.2 - 串口DMA高效收发实战2：进一步提高串口接收的效率]]》前阵子完成的LL库与寄存器版本的模块，有一个明显的缺点是不支持多实例化。总的来说，就是模块化没考虑进去。最近，开始基于HAL库系统地梳理一遍bootloader程序开发。所以，继续把代码迭代一下，将多实例化模块做出来。

bsp_usart_hal 驱动代码特点总结：
1. 支持多实例通用管理
	- 设计为USART_Driver_t结构体+接口函数，支持多个USART端口同时独立驱动，便于单板多串口应用、项目横向复用、一套代码多项目。
	- 各实例参数（缓冲区、DMA句柄、UART句柄）解耦，代码维护简便。

2. DMA收发全流程、双缓冲高效传输
	- 接收采用DMA环形模式，支持半传输（HT）、全传输（TC）、IDLE三类中断协同搬运，保证任意长度数据不丢包、无粘包。
	- 发送采用DMA块传输，自动调度RingBuffer队列，避免CPU阻塞。
	- 收发均使用DMA，极大减轻CPU负担，适用于高带宽、高实时性场景。

3. RingBuffer无缝缓存机制
	- 内置收发双向RingBuffer，自动管理协议包拼接、数据缓冲，简化上层协议处理。
	- 支持超大缓冲、溢出自动覆盖或丢弃旧数据，易于移植第三方协议栈。

4. 健壮的错误统计与自恢复机制
	- 内置DMA传输错误、串口硬件错误等统计计数（errorDMATX/errorDMARX/errorRX），便于产线异常监控、后期故障溯源。
	- 检测到DMA错误时，自动执行自恢复：自动重启DMA、自动清理异常、可定制连续多次异常的告警或自动复位，保障系统长期稳定运行。

5. 工程化量产导向
	- 代码结构清晰、注释标准，适用于量产项目长期维护。
	- CubeMX工程直接集成，无需魔改HAL库代码。
	- 支持多串口、多DMA。

测试效果如下：
![[Pasted image 20250523170304.png | 1100]]