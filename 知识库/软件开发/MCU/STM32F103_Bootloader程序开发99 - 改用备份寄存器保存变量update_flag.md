# 导言
---
使用备份寄存器会有一个坑，暂时不考虑用备份寄存器了。`_SystemStart()`函数在main()之前执行。此时系统时钟与RTC时钟还没有初始化，导致备份寄存器限制读写。所以update_flag保存在备份寄存器的话，会有问题！！！！
后续，有时间再整理怎样解决吧！！！！！
![[Pasted image 20250626191846.png]]


















`本章节的目的是证明可以使用备份寄存器来保存app_jump.c的变量update_flag。`之前，update_flag变量保存在IRAM2里，如下所示。
![[Pasted image 20250626144403.png | 1100]]

另外，`替代备份寄存器的前提是VBAT没有接电池，否则要修改代码才能正常跳转App。`

![[Pasted image 20250626145811.png | 1100]]
如上所示，将开发板的纽扣电池扣掉。

# 一、备份寄存器
----
![[Pasted image 20250626141957.png]]
以上摘自STM32F1xx的参考手册，总得来说，备份寄存器是一个SRAM寄存器。
- 如果VBAT没有接电池的话（比如纽扣电池），开发板掉电后，备份寄存器的值会清0（`这个特性，恰好可以用来保存IAP升级的“升级状态”`）。
- 如果VBAT接上电池。开发板掉电后，备份寄存器的值会保存下来（比如在备份寄存器1存了2000，控制板掉电后再重新上电，读取备份寄存器1的值，还是2000）。

# 二、用备份寄存器替代之前定义的IRAM2，用于保存“升级标志”update_flag
---
![[Pasted image 20250626143605.png | 1100]]
如上所示，app_jump.c的全局变量保存在IRAM2里。