# 导言
---
《[[STM32F103_HAL库+寄存器学习笔记16 - 监控CAN发送失败（轮询方式）]]》完成用轮询的方式去监控CAN的错误状态。

在CAN通信中，轮询和中断方式检测错误状态各有其适用场景和优缺点：
1. **轮询方式（Polling）的优点：**
- 实现简单。无需配置中断向量，直接在主循环中定期检查错误寄存器即可。
```c
while (1) {
    /* 监控CAN错误 */
    if (CAN_Check_Error() == 0x03) { // 因为错误太严重，进入离线状态
        g_BusOffCount++;      // 每发生一次busoff严重错误，记录一次
        CAN_BusOff_Recover(); // 离线状态恢复
    } else {
        // 其他错误与没有错误
    }
    HAL_Delay(1); // 1ms轮询间隔
}
```
- 确定性高，错误检测的时机由主循环控制，适合对实时性要求不严格的场景。
- 无中断开销，节省中断上下文切换的时间（约20-50个CPU周期）。
**缺点**：
- 实时性差，错误从发生到被检测的延迟取决于轮询间隔（如10ms轮询时，最大延迟10ms）。
- CPU资源浪费，高频轮询（如1ms）会占用大量CPU时间，低频率则可能错过瞬时错误。

2. **中断方式的优点：**
- 实时快速响应。当错误发生时，中断可以立即触发 ISR，实现快速响应，特别适合对时延要求严格的应用场景。
- 提高 CPU 利用率。在平时（错误没有发生时），CPU 可以处于低功耗模式或者执行其他任务，中断仅在需要处理异常时才介入，整体上提高了系统资源的利用率。
**缺点**：
- 实现复杂度增加。中断处理需要综合考虑中断优先级、数据一致性、上下文切换以及可能的嵌套中断等问题，开发和调试的难度相对较大。
- 上下文切换开销。每一次中断都会引起一定的上下文保存与恢复开销，若错误频繁发生，中断响应及中断处理代码可能对系统性能产生较大影响。

3. 混合方式（轮询+中断）
- 轮询方式适用于：
	- 对实时性要求较低的系统。
	- 错误发生频率低、系统负载较轻的应用。
	- 开发周期紧张、期望简化逻辑和降低调试难度的场景。
- 中断方式适用于：
	- 对错误响应要求较高，需要快速捕捉和处理异常的系统。
	- 系统负载较大，且希望在错误发生时立即调度其他关键任务。
	- 有经验处理复杂中断及优先级调度的开发团队，可以较好地控制中断带来的潜在问题。
在实际设计中，使用混合方式是一个非常不错的选择：使用中断来快速捕获错误信号，再在主循环中做进一步处理。这样既能保证实时响应，也能减轻中断服务程序的复杂性，确保错误处理的完整性。




项目地址：

# 一、CAN中断使能寄存器 (CAN_IER)
---
![[Pasted image 20250409151451.png]]
![[Pasted image 20250409151510.png]]
如上所示，CAN_IER 寄存器用于启用或关闭 CAN 控制器内与数据传输、接收以及错误处理相关的各个中断。通过配置该寄存器，可以让系统在发生特定事件时自动触发中断，从而及时响应并处理这些事件。对于每个中断源，软件均可单独使能或禁止中断，以便根据系统需求调优实时性和CPU负担。

## 1.1、各个位功能说明
**TMEIE（Transmit Mailbox Empty Interrupt Enable）**
作用： 使能发送邮箱空中断。当一个发送邮箱由“占用”状态变为空闲时，会触发此中断，提示软件可以提交新的待发送消息。
应用： 优化发送数据流程，确保在邮箱空闲时及时加载新数据，避免因发送延时而浪费带宽。

**FMPIE0（FIFO Message Pending Interrupt Enable for FIFO0）**
作用： 使能 FIFO0 消息挂起中断。当接收FIFO0中有新消息（未被读取的消息）时，会触发中断通知上层软件。
应用： 提高接收数据的实时性，尤其在数据流较快时能及时处理接收到的新消息。

**FOVIE0（FIFO0 Overrun Interrupt Enable）**
作用： 使能 FIFO0 过载中断。如果 FIFO0 内数据未被及时读取而导致溢出，将触发中断。
应用： 警示接收缓冲区可能出现数据丢失，便于软件采取措施防止过载。

**FOVIE1（FIFO1 Overrun Interrupt Enable）**
作用： 类似于 FOVIE0，但针对 FIFO1（如果存在）进行过载中断配置。
应用： 在使用多个FIFO的情况下，确保各个FIFO均能在发生溢出时通知软件。

**EWGIE（Error Warning Interrupt Enable）**
作用： 使能错误警告中断。当CAN错误计数器（发送或接收）的值超过预警阈值时，会触发此中断。
应用： 作为提前预警，提示系统错误可能在增多，便于软件在错误尚未导致严重后果前采取预防措施。

**EPVIE（Error Passive Interrupt Enable）**
作用： 使能错误被动中断。当错误计数器超过一定值，导致CAN控制器进入错误被动状态时，产生中断。
应用： 监控并记录网络通信质量下降的情况，确保在进入错误被动状态后能迅速发出异常警报。

**BOFIE（Bus-Off Interrupt Enable）**
作用： 使能总线关闭（Bus-Off）中断。当错误累计过多，导致节点被强制移出总线通信（Bus-Off状态）时，会触发此中断。
应用： 关键事件处理，借助此中断可以在短时间内对CAN进行复位或重新初始化，恢复通信。

**LECIE（Last Error Code Interrupt Enable）**
作用： 使能最后错误代码中断。当 LEC 字段（记录最后一次错误代码）的值发生变化时会触发中断。
注意： 此中断可以帮助开发者调试和记录错误类型，但由于 LEC 可能会频繁变化（例如一些瞬时错误），容易导致中断过于频繁，一般在设计中往往采用轮询方式来获取 LEC 状态。

**ERRIE（Error Interrupt Enable）**
作用： 全局错误中断使能。当 ERRIE 置位后，与错误相关的各个中断（如 EWGIE、EPVIE、BOFIE、LECIE）将整体被激活，并可通过统一的中断入口响应所有错误事件。
注意： 开启ERRIE后，任何错误状态的变化都可能引起中断，若错误事件较多，会增加系统的中断负担。因此，在设计时需要根据应用场景选择是否启用全局错误中断，或者只启用部分关键错误中断。

## 1.2、启动中断（错误警告EWGIE、错误被动EPVIE、总线关闭BOFIE）
```c
    /* 启用错误警告、错误被动及总线关闭中断（请确保这些宏在你的工程中已定义） */
    CAN1->IER |= (CAN_IER_EWGIE | CAN_IER_EPVIE | CAN_IER_BOFIE);
```

## 1.3、为什么不开启中断（最后错误代码LECIE、全局错误ERRIE）
**最主要的顾虑是中断频率过高，易产生中断风暴。** 一个嵌入式系统，CAN通讯大概率只是其中一个小模块。绝对不可能因为CAN总线发生错误而影响整个嵌入式系统的实时性。LEC（最后错误代码）反映的是总线上出现的各类瞬时错误，如填充错误、格式错误等，这些错误可能在总线上短暂发生且恢复正常。如果使能 LECIE，每当 LEC 字段发生变化时都会触发中断，可能会造成大量频繁的中断请求。这种情况下，系统会因响应大量短暂且不严重的错误中断而导致中断风暴，增加系统处理负担，从而影响实时性能。另外，ERRIE（Error Interrupt Enable）是CAN控制器中一个全局错误中断使能位，它用于使能整个错误中断机制，简单来说，当ERRIE被置位时，CAN控制器任何错误状态都会触发中断（包括LECIE）。

# 二、代码（寄存器方式）
---
## 2.1、myCanDrive.c

# 三、碰到问题
---
触发Bus-off错误，重新初始化完CAN之后。只要ERRIE被置1就会一直执行中断函数CAN1_SCE_IRQHandler(),导致主循环没办法执行。暂时找不到解决方法，先不管错误中断功能。





