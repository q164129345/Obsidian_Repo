# 导言
---
《[[STM32F103_LL库+寄存器学习笔记09 - DMA串口接收与DMA串口发送，串口接收空闲中断]]》上一章节完成DMA发送与接收。此时，有一个致命的问题可能会导致数据包丢失。原因是USART1接收只开启了接收空闲中断(IDLE)，DMA在连续模式下，如果数据一直持续发送（或者数据包的大小比接收缓存区要大），将会出现数据被覆盖，被覆盖的数据等于丢失的数据。

实现更加健壮的串口接收程序是**同时利用USART空闲中断来判断数据包的结束，并配合DMA半传输和传输完成中断及时处理数据，从而避免数据溢出或被覆盖。** 总的来说就是**接收空闲中断 + DMA传输过半中断 + DMA传输完成中断。** 
方案如下：
1. 开启接收空闲中断
	- 当数据传输过程中出现空闲（即一段数据传输结束后总线静默），USART空闲中断就会触发。这时，立即关闭DMA，读取DMA剩余计数器（或利用缓冲区总大小减去剩余计数得到实际接收字节数），将这部分数据交给上层处理，然后清除中断标志并重新启动DMA。这样即使数据包不足一个完整缓冲区，也能准确提取数据。
2. 开启半传输和全传输中断
	- 半传输中断：当DMA接收到缓冲区前半部分的数据时触发。此时可以先处理前半部分的数据，避免数据不断写入后覆盖还未处理的数据。
	- 传输完成中断：当DMA完成整个缓冲区的数据接收时触发，同样可处理后半部分数据。这种“双缓冲”技术允许你在数据接收的同时就将已接收部分取出处理，降低丢包风险。

总的来说：
- **对于连续且数据量较大的情况，DMA半传输和传输完成中断能保证数据能及时被轮换处理，不会因缓冲区满而丢失数据。**
- **对于数据量较小或者数据传输间有间隔的情况，空闲中断能够准确捕获数据包结束时刻，防止因数据不足而不触发DMA半/全传输中断而导致数据滞留。**

另外，中断的处理必须保证简单，尽可能保证**快进快出。** 所以，数据的处理必须留在主循环来做（配合高效的数据结构ringbuffer）。后续章节会介绍ringbuffer的移植与使用。

![[Pasted image 20250307113632.png]]

# 一、代码
---