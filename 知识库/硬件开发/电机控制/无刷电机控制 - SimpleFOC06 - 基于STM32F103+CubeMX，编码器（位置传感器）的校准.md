# 导言
---
上一章节《[[无刷电机控制 - SimpleFOC05 - 基于STM32F103+CubeMX，实现速度开环控制]]》完成三相无刷电机的开环速度控制。接下来，开始调试编码器（位置传感器）。为接下来的位置闭环控制，速度闭环控制做准备。

### RTT_Viewer
![[Pasted image 20250108184226.png]]

### 编码器校准的动作
![[飞书20250108-121114.mp4]]

# 一、校准编码器的目的
---
![[Pasted image 20250107211108.png]]
**校准编码器的目的是确定编码器的方向direction与计算出偏移角度offset。** 编码器输出的方向可能与电机的旋转方向不一致，它们之间的方向关系是1或者-1。校准方向一次只需要进行一次，同一个电机与编码器只需要校准一次，后续就可以写死在程序里。编码器安装在电机轴上时，可能由于安装的角度误差，导致编码器与电机转子之间产生固定的角度偏移，它就是偏移角offset。理论上来说，这个偏移角等于0。每一个电机与编码器的组合都要校准一遍，因为每一个的安装公差都不一样。校准之后，可以将偏移角保存在Flash里，程序初始化时，从flash里读取出来。

# 二、代码
---
## 2.1、user_main.cpp
![[Pasted image 20250108184328.png]]
如上图所示，增加三句代码后，运行代码`motor_initFOC()`的时候会执行编码器的校准，最终的到编码器方向CCW与编码器偏移角2.0264。
![[Pasted image 20250108165547.png]]
如上所示，编译代码成功，下载到开发板即可。

# 三、细节补充
---
## 3.1、motor.initFOC()执行编码器校准的流程
![[Pasted image 20250108170442.png]]
![[Pasted image 20250108171806.png]]
![[Pasted image 20250108172147.png]]
如上所示，simpleFOC校准编码器的代码真的很简单。

## 3.2、为什么计算偏移角时，需要将磁场方向固定在电角度_3PI_2（270度）？
**便于实现一个稳定的转子位置**。在 FOC 控制中，转子的稳定位置依赖于定子产生的磁场方向。如果施加的电角度为_3PI_2，实际上是将电机定子的磁场指向一个固定方向。
1. 电角度270度是一个常用的选择，因为这个角度会使得转子受到定子磁场的吸引，最终停留在唯一确定的位置。
2. 为什么选择固定方向：校准的关键是将转子停在一个已知的位置，以便读取编码器的机械角度。因此，任何固定且有效的电角度都可以实现这一目标,电角度_3PI_2 是其中一种常用的选择。
电角度270度有如下优点：
1. 对应于三相电压波形，设Ua、Ub、Uc三相电压，电角度270度时通常会产生一种对称且平衡的三相电流波形。
2. 在三相电压空间矢量调制（SVPWM）中，电角度270度常被用作对齐的基准点，避免了更复杂的电压矢量计算。
3. 电角度0度或360度通常对应于特定相电压完全导通的情况，可能导致电机电流不平衡或抖动。而电角度270度通常位于电压波形的较平滑区域，更容易生成稳定的磁场，避免转子不必要的振动。






